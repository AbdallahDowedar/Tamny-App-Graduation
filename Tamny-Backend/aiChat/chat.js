import dotenv from 'dotenv';
dotenv.config();

// ุงุณุชูุฑุงุฏ ููุชุจุฉ Together AI
import Together from "together-ai";

// ุฅูุดุงุก ูุงุฆู ูู ููุชุจุฉ Together
const together = new Together({  apiKey: '91bebf5745ef05b2c1f63eb9661384fc03ff8bbe3c36a9fb084815d001fd3c99' });

// ูุงุจ ุงูุชุฎุตุตุงุช ูุงูุฏูุงุชุฑุฉ
const specialtyMap = {
  "ุฌูุงุฒ ูุถูู": [
    "ุฏูุชูุฑ/ ูุญูุฏ ุนุจุงุณู", "ุฏูุชูุฑ/ ุทุงุฑู ุงูุงู", "ุฏูุชูุฑ/ ูุญูุฏ ูุตุทูู ุนุงูุฑ",
    "ุฏูุชูุฑ/ ูุญูุฏ ุณุนุฏ", "ุฏูุชูุฑ/ ุฃููู ุฃุญูุฏ ุตูุฑ", "ุฏูุชูุฑ/ ูุญูุฏ ูุงูู ุงููููู",
    "ุฏูุชูุฑ/ ุฃุญูุฏ ูุญูุฏ ูุฎุชุงุฑ ูุญูู", "ุฏูุชูุฑ/ ูุจูู ูุงุดูู", "ุฏูุชูุฑ/ ุตููุช ุนุจุฏ ุงูุญููู",
    "ุฏูุชูุฑ/ ุฃุญูุฏ ูุฑุญุงุช", "ุฏ/ ูุญููุฏ ุญููู ุนูุงู", " ุฏูุชูุฑ/ูุตุทูู ุดุนูุงู",
    "ุฏ/ ูุญููุฏ ูุญููุฏ ุฒุงูุฏ", "ุฏูุชูุฑ/ ุฃุญูุฏ ุตูุงุญ ุณูู", "ุฏ/ุงุญูุฏ ุนุจุฏ ุงููุชุงุญ",
    "ุฏูุชูุฑ/ ุญููู ุงูุดุงุฐูู", "ุฏ/ ุฃุญูุฏ ุนุจุฏ ุงููุชุงุญ ูุญูุฏ"
  ],
  "ููุจ ูุฃูุนูุฉ ุฏูููุฉ": [
    "ุฏ/ ูุญูุฏ ุนุงุตู ุนูุงู", "ุฏ/ุจูุงุก ุงููุตุงุต", "ุฏ/ูุฑุณู ูุตุทูู", "ุฏ/ ูุญูุฏ ุฃุญูุฏ ุฎููู",
    "ุฏูุชูุฑ ุฃุญูุฏ ุตุงุจุฑ", "ุฏ/ ุชุงูุฑ ุงูุฃุตูุฑ", "ุฏ/ ูุญูุฏ ุฌูุงู ูุดุงุญูุช", "ุฏ/ ุนูู ูุตุฑ ูุดุนู",
    "ุฏ/ ูุงุฏุฑ ูุญูุฏ ุตููุฉ", "ุฏ/ ููุฑ ุนูุงุฏ ุนุงูุฑ", "ุฏ/ ูุญูุฏ ุฌูุงู ูุดุงุญูุช", "ุฏ/ ุนูุฑู ุนุจุฏ ุงููุฑุถู ุณููุฉ",
    "ุฏ/ ุฃุญูุฏ ูุฌุฏู", "ุฏ/ ุญุณู ุฎููู", "ุฏ/ ุญูุงู ูุญูุฏ ุฒุงูุฏ", "ุฏ/ ุงุจุฑุงููู ุดุญุงุชุฉ"
  ],
  "ูุฎ ูุฃุนุตุงุจ": [
    "ุฏ/ ูุญูุฏ ุงูุฏูุจ", "ุฏ/ ูุญูุฏ ุณุงูู", "ุฏ/ ูุญูุฏ ุจุญุจุญ", "ุฏ/ ูุญูุฏ ุงูุณุนูุฏ ูุงุดูู",
    "ุฏ/ ุญุณูู ุฒูุฑูุง", "ุฏ/ ุฃุญูุฏ ูุตูุฑ ูุจุงุฑู", "ุฏ/ ูุญูุฏ ุฃุญูุฏ ุงูุทุจู", "ุฏ/ ุฃููู ุงููููุงูู",
    "ุฏ/ ุนุงุฏู ุนุจุฏ ุงููุฑูู ุจุฏูู", "ุฏ/ ูุญูุฏ ุฑูุถุงู ุณูุทุงู", "ุฏ/ ุงุจุฑุงููู ุงูุณูุฏ ุงูุงุญูุฑ",
    "ุฏ/ ุฃุณุงูุฉ ุดุฑูู", "ุฏ/ ุณุงูุญ ุนุจุฏ ุงููู ุนุจุฏ ุงููุจู", "ุฏ/ ุงุดุฑู ุนุจุงุณ",
    "ุฏ/ ูุญูุฏ ุณุงูู", "ุฏ/ ุฃุญูุฏ ุนุจุฏ ุงูุญููู"
  ],
  "ุณูุฑู ูุบุฏุฏ ุตูุงุก": [
    "ุฏ/ ูุณุงู ุงูุฎููู", "ุฏ/ ุณูุฏ ุฃุญูุฏ ุญูุต", "ุฏ/ูุนุงุฐ ุจูุฑ", "ุฏ/ ุงุณูุงู ุงูุณูุฏ",
    "ุฏ/ุฒููุจ ุตุจุฑู ุฃุจู ุฒูุฉ", "ุฏ/ ุณูุงุก ุฌุฒุงุฑูู", "ุฏ/ูุญููุฏ ุนูุงุฑุฉ", "ุฏ/ ุดููุงุก ุฒููู",
    "ุฏ/ููุซู ุฑุถุง ุจุฏุฑ", "ุฏ/ุฃููุฑ ููุฑู ูุฑุฒูู", "ุฏ/ ูุตุทูู ุงููุฌุงุฑ", "ุฏ/ ููุงุฑ ูุญูุฏ ุงูุฌุจุงูู",
    "ุฏ/ุงุญูุฏ ุณูุงู"
  ],
  "ุฃูุฑุงุถ ููู": [
    "ุฏ/ ุจูุชุฑ ุณููุฑ", "ุฏ/ูุนุงุฐ ุจูุฑ", "ุฏูุชูุฑ/ ูุญูุฏ ุดูุฑู", "ุฏูุชูุฑ/ ูุงุณูู ูุงุดูู",
    "ุฏ/ุนูู ุณุนุฏ ุงูุฏูู", "ุฏ/ ุชุงูุฑ ุดูุงุจ", "ุฏ/ ุนุจุฏุงููู ุจููุณู", "ุฏ/ ูุญุณู ุนุจุฏุงูุฑุงุฒู",
    "ุฏ/ุงุญูุฏ ุงููุงุดู", "ุฏ- ุฃุญูุฏ ุดููู", "ุฏ/ ุญุฌุงุฒู ูุฎููู", "ุฏ/ ุฃุญูุฏ ุนูู ุฒูุฑุฉ",
    "ุฏ/ุงุณุงูุฉ ุนุจุฏ ุงูุฌูุงุฏ", "ุฏ/ ูุญูุฏ ุบุฑุงุจ", "ุฏ/ ุนุงุฏู ุญุงูุธ", "ุฏ/ ุจุงูุฑ ูุญูุฏ ุนุจุฏ ุงูุฑุคูู",
    "ุฏ/ ุนูู ุฌุงุฏ ุงููู", "ุฏ/ุนุจุฏุงููู ุงุญูุฏ ุนุงูุฑ", "ุฏ/ ูุตุทูู ุฌุจุฑูู", "ุฏ/ ูุญูุฏ ูุงูู ุดุนุจุงู"
  ],
  "ุฌูุฏูุฉ": [
    "ุฏ/ุฑุญุงุจ ูุญูุฏ ูููู", "ุฏ. ุฅููุงุณ ุฃุจู ุงููุชุญ", "ุฏ/ ุฌูุงูุงุช ูุชุญู ุงูุฏุฌูู", "ุฏ. ูุญูุฏ ุญูุฏู ุนุงุจุฏูู",
    "ุฏ. ูุจุฉ ุนุจุฏ ุงููุจู ุนุตุฑ", "ุฏ.ุฑุญุงุจ ุนุดุฑู", "ุฏูุชูุฑ ูุญูุฏ ุนุจุฏ ุงูุณูุงู ุญููุฏุฉ", "ุฏ ุฃุดุฑู ุบุฑูุจ",
    "ุฏ/ ุนูุงุก ุงูุฏุณููู", "ุฏ/ุงุญูุฏ ุนุจุฏ ุงูููุงุจ", "ุฏ. ุดููู ูุญููุฏ ุงููุฑุงุฌู", "ุฏ. ุญูุงู ุงุณูุงุนูู ุฑุดูุฏ",
    "ุฏูุชูุฑ ุฃุญูุฏ ุฎูู", "ุฏูุชูุฑ ูุญูุฏ ูุดุงู", "ุฏูุชูุฑ ูุฌุฏู ุดุงูู", "ุฏ.ุงุญูุฏ ุดุงูุฑ ุงุจู ุญุฌุฑ",
    "ุฏ.ุจุซููุฉ ุทุงุฑู", "ุฏ. ุณููุฑ ูุญููุฏ ุงูุฌูู"
  ],
  "ุฃูู ูุฃุฐู ูุญูุฌุฑุฉ": [
    "ุฏูุชูุฑ/ ุจุงุณู ุณููุฏ", "ุฏูุชูุฑ/ ุนุจุฏุงูุฑุญูู ุฌูููู", "ุฏูุชูุฑ/ ุฃุญูุฏ ุงูุจุฑูู",
    "ุฏ.ุญุงุชู ุงูุญุจุดู", "ุฏ. ุฃุญูุฏ ูุดุฃุช ุนููู", "ุฏ ุญุงุชู ุฃุญูุฏ ุณูุงูุฉ", "ุฏ/ ูุญูุฏ ุงูุฎููู"
  ],
  "ุฑููุงุชูุฒู": [
    "ุฏ/ุนูุงุฏ ุงูุดูุจููู", "ุฏ/ุนูุงุก ูุจูุจ", "ุฏ/ ุฏุนุงุก ุงูุดุงูู", "ุฏ/ ุนูุฑ ุงุจู ุงูุญุณู",
    "ุฏ/ ุณูุฑ ุฌุงุจุฑ ุณูููุงู", "ุฏ/ูุจุฉ ุฃุญูุฏ ุงูุนุณููู", "ุฏ/ ุทุงุฑู ูุงูู ุงุจุฑุงููู"
  ]
};

// ุงููุธููุฉ ุงูุฃุณุงุณูุฉ
async function generatePlan(userSymptoms) {    
    // ุชุญููู ูุฏุฎูุงุช ุงููุณุชุฎุฏู ุฅูู ุงููุต ุงูููุงุณุจ
    const symptoms = typeof userSymptoms === 'object' ? userSymptoms.userSymptoms : userSymptoms;
      const prompt = `
    ุนูุฏู ุงูุชุฎุตุตุงุช ุงูุทุจูุฉ ุงูุชุงููุฉ ููุท:
    
    - ุฌูุงุฒ ูุถูู
    - ููุจ ูุฃูุนูุฉ ุฏูููุฉ
    - ูุฎ ูุฃุนุตุงุจ
    - ุฌูุฏูุฉ
    - ุฑููุงุชูุฒู
    - ุณูุฑู ูุบุฏุฏ ุตูุงุก
    - ุฃูุฑุงุถ ููู
    - ุฃูู ูุฃุฐู ูุญูุฌุฑุฉ
    
    ๐ ุนูุฏูุง ุฃุนุทูู ุฃุนุฑุงุถูุงุ ุญุฏูุฏ ุงูุชุฎุตุต ุงูููุงุณุจ ููุท **ูู ุจูู ุงููุงุฆูุฉ ุฃุนูุงู**.
    
    โ ุฑุฏู ูุฌุจ ุฃู ูููู ุจูุฐุง ุงูุดูู:
    
    {
      "specialty": "ุงุณู ุงูุชุฎุตุต ูู ุงูููุฌูุฏูู ููุท",
      "advice": "ูุตุงุฆุญ ุทุจูุฉ ุนุงูุฉ ูุฅุฑุดุงุฏุงุช ูููุฉ"
    }
    
    ุงูุฃุนุฑุงุถ ุฃู ุงูุงุณุชูุณุงุฑ: ${symptoms}
    
    ููุงุญุธุฉ: ุณุฃูุฏู ูุตุงุฆุญ ุนุงูุฉ ูุบูุฑ ุญุณุงุณุฉุ ูุน ุงูุชุฃููุฏ ุฏุงุฆูุงู ุนูู ุฃูููุฉ ุงุณุชุดุงุฑุฉ ุงูุทุจูุจ ุงููุฎุชุต.
    `;
        try {
        console.log('ุงูุฃุนุฑุงุถ ุงููุณุชููุฉ:', userSymptoms);
        
        const response = await together.chat.completions.create({
          messages: [{ role: "user", content: prompt }],
          model: "meta-llama/Llama-3.3-70B-Instruct-Turbo",
        });
      
        console.log("ุงุณุชุฌุงุจุฉ API ุงููุงููุฉ:", response);
        
        let modelReply;
        try {
            const content = response.choices[0].message.content;
            console.log("ูุญุชูู ุงูุฑุฏ:", content);
            modelReply = JSON.parse(content);
        } catch (parseError) {
            console.error("ุฎุทุฃ ูู ุชุญููู ุงูุฑุฏ:", parseError);
            throw new Error("ูุดู ูู ุชุญููู ุฑุฏ AI");
        }

        if (!modelReply || !modelReply.specialty) {
            throw new Error("ุงูุฑุฏ ุบูุฑ ุตุงูุญ ูู AI");
        }        const specialty = modelReply.specialty;
        const doctors = specialtyMap[specialty] || [];
        const advice = modelReply.advice || "ูุฑุฌู ุงุณุชุดุงุฑุฉ ุงูุทุจูุจ ุงููุฎุชุต ููุญุตูู ุนูู ูุตูุญุฉ ููุตูุฉ";
        return {
          specialty,
          doctors,
          medicalAdvice: advice
        };
      } catch (error) {
        console.error("โ ุฎุทุฃ ูู ุงูุงุชุตุงู ุจู Together API:", error.message);
        console.error("ุชูุงุตูู ุงูุงุณุชุฌุงุจุฉ:", error.response?.data); // ุทุจุงุนุฉ ุชูุงุตูู ุงูุงุณุชุฌุงุจุฉ
        return { error: "ูุดู ูู ุงูุงุชุตุงู ุจู Together API" };
      }
      
}

export { generatePlan };
